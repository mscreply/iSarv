@page "{testId:int}"
@model iSarv.Areas.Test.Pages.Clifton.TakeTestModel

@{
    ViewData["Title"] = Localizer.Text("Take Clifton Test");
}

<h1>@Localizer.TextIgnoreCase("Take Clifton Test")</h1>

@if (Model.IsNotStarted)
{
    <div>@Localizer.TextIgnoreCase("Your Clifton Test has not been started!")</div>
}
else if (Model.IsDoneOrExpired)
{
    <div>@Localizer.TextIgnoreCase("Your Clifton Test has been completed or expired!")</div>
}
else
{
    <form method="post" id="testForm">
        <div id="step-container">
            <div class="step" id="step-1" style=@(Model.CurrentStep != 1 ? "display:none;" : "")>
                <p>@Localizer.TextIgnoreCase("Welcome to the Clifton Talent Assessment Test (CSTA)!")</p>
                <p>@Localizer.TextIgnoreCase("The Clifton Strength Test helps you discover your strengths. Please read each question carefully and select the option that best describes you.")</p>
                <p>@Localizer.TextIgnoreCase("Before you begin, please read the instructions on the next page carefully. The test consists of 177 pairs of statements, each describing your individual characteristics. You must select only the one statement from each pair that best describes you.")</p>
                <p>@Localizer.TextIgnoreCase("Note: There is a time limit for each question and you have only 40 seconds to answer.")</p>
                <p>@Localizer.TextIgnoreCase("Ensure you answer all questions before submitting.")</p>
                <p>@Localizer.TextIgnoreCase("Click \"Next\" to begin.")</p>
                <button class="btn btn-primary next-step" data-next="2">@Localizer.TextIgnoreCase("Next")</button>
            </div>

            <div class="step" id="step-2" style=@(Model.CurrentStep != 2 ? "display:none;" : "")>
                <h2>@Localizer.TextIgnoreCase("Clifton Test Instructions")</h2>
                <p>@Localizer.TextIgnoreCase("The Clifton Strengths Talent Assessment Test (CSTA) consists of 177 pairs of statements. From each pair, select the statement that best matches your characteristics.")</p>
                <p>@Localizer.TextIgnoreCase("Try to avoid neutral options as much as possible. Usually, one of the two statements is closer to you. If both statements match you, choose the one that better or more closely describes you.")</p>
                <p>@Localizer.TextIgnoreCase("This test is timed. You have only 40 seconds for each question, so don’t overthink; trust your first instinct.")</p>
                <p>@Localizer.TextIgnoreCase("Below is a sample question. Choose the statement that best describes you")</p>
                <div class="container" style="display: flex;">
                    <table class="w-100 p-5 text-center bg-light m-2 mb-5">
                        <tr>
                            <td width="20%">@Localizer.TextIgnoreCase("Strongly describes me")</td>
                            <td width="20%">@Localizer.TextIgnoreCase("Describes me")</td>
                            <td width="20%">@Localizer.TextIgnoreCase("Neutral")</td>
                            <td width="20%">@Localizer.TextIgnoreCase("Describes me")</td>
                            <td width="20%">@Localizer.TextIgnoreCase("Strongly describes me")</td>
                        </tr>
                        <tr>
                        <td class="bg-primary text-white p-2"><input type="radio" value="+2" name="test" class="form-check-input"></td>
                        <td class="bg-info text-white p-2"><input type="radio" value="+1" name="test" class="form-check-input"></td>
                        <td class="bg-light text-dark p-2"><input type="radio" value="0" name="test" checked class="form-check-input"></td>
                        <td class="bg-success text-white p-2"><input type="radio" value="-1" name="test" class="form-check-input"></td>
                        <td class="bg-dark text-white p-2"><input type="radio" value="-2" name="test" class="form-check-input"></td>
                        <tr>
                            <td colspan="2" class="fs-3 text-primary">@Localizer.TextIgnoreCase("I read all instructions before starting.")</td>
                            <td></td>
                            <td colspan="2" class="fs-3 text-success">@Localizer.TextIgnoreCase("I don’t like reading and start tasks immediately.")</td>
                        </tr>
                    </table>
                </div>
                <p>@Localizer.TextIgnoreCase("If you understand the instructions, select \"Next\" to proceed to the main questions.")</p>
                <button class="btn btn-primary next-step" data-next="3">@Localizer.TextIgnoreCase("Next")</button>
            </div>

            @for (int i = 0; i < Model.Questions.Count; i++)
            {
                var question = Model.Questions[i];
                <div class="step p-5" id="step-@(i + 3)" style=@(Model.CurrentStep != i + 3 ? "display:none;" : "")>
                    <table class="w-100 p-5 text-center bg-light m-2 mb-5">
                        <thead>
                            <tr><th colspan="5"><h4 class="mb-4">@Localizer.TextIgnoreCase("Question") @question.Id</h4></th></tr>
                        </thead>
                        <tr>
                            <td width="20%">@Localizer.TextIgnoreCase("Strongly describes me")</td>
                            <td width="20%">@Localizer.TextIgnoreCase("Describes me")</td>
                            <td width="20%">@Localizer.TextIgnoreCase("Neutral")</td>
                            <td width="20%">@Localizer.TextIgnoreCase("Describes me")</td>
                            <td width="20%">@Localizer.TextIgnoreCase("Strongly describes me")</td>
                        </tr>
                        <tr>
                        <td class="p-2" style="background-color: #87CDF6"><input type="radio" name="answers[@(question.Id - 1)]" value="4" class="form-check-input" @(Model.Answers[question.Id - 1] == 4 ? "checked" : "")></td>
                        <td class="p-2" style="background-color: #AEE7F8"><input type="radio" name="answers[@(question.Id - 1)]" value="3" class="form-check-input" @(Model.Answers[question.Id - 1] == 3 ? "checked" : "")></td>
                        <td class="p-2" style="background-color: #CFFFF6"><input type="radio" name="answers[@(question.Id - 1)]" value="2" class="form-check-input" @(Model.Answers[question.Id - 1] == 2 ? "checked" : "")></td>
                        <td class="p-2" style="background-color: #ABF1BC"><input type="radio" name="answers[@(question.Id - 1)]" value="1" class="form-check-input" @(Model.Answers[question.Id - 1] == 1 ? "checked" : "")></td>
                        <td class="p-2" style="background-color: #8CE68C"><input type="radio" name="answers[@(question.Id - 1)]" value="0" class="form-check-input" @(Model.Answers[question.Id - 1] == 0 ? "checked" : "")></td>
                        <tr>
                            <td colspan="2" class="fs-3 text-primary">@Localizer.TextIgnoreCase(question.StatementA)</td>
                            <td></td>
                            <td colspan="2" class="fs-3 text-success">@Localizer.TextIgnoreCase(question.StatementB)</td>
                        </tr>
                    </table>
                    @if (i < Model.Questions.Count - 1)
                    {
                        <button class="btn btn-primary next-step" data-next="@(i + 4)">@Localizer.TextIgnoreCase("Next")</button>
                        <a href="#" class="btn btn-success" onclick="saveTestProgress()">@Localizer.TextIgnoreCase("Save")</a>
                    }
                    else
                    {
                        <button class="btn btn-success" id="submit-test">@Localizer.TextIgnoreCase("Submit Test")</button>
                    }
                </div>
            }
        </div>
        <input type="hidden" name="currentStep" asp-for="CurrentStep">
    </form>
}

<div id="fulfill-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0); color: white; z-index: 1000; justify-content: center; align-items: center; flex-direction: column;">
    <h2>@Localizer.TextIgnoreCase("Time Expired!")</h2>
    <p>@Localizer.TextIgnoreCase("You have exceeded the time limit for this question.")</p>
    <button id="continue-test" class="btn btn-primary">@Localizer.TextIgnoreCase("Continue")</button>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            let currentStep = 1;
            let timer;
            let timeLimit = 40; // seconds

            function startTimer() {
                timer = setTimeout(function () {
                    $("#fulfill-overlay").css("display", "flex");
                }, timeLimit * 1000);
            }

            function stopTimer() {
                clearTimeout(timer);
            }

            function showStep(step) {
                stopTimer();
                $(".step").hide();
                $("#step-" + step).show();
                currentStep = step;
                if (step > 2 && step <= @Model.Questions.Count + 2) { // Only start timer for question steps
                    startTimer();
                }
            }

            $(".next-step").on("click", function (e) {
                e.preventDefault();
                let nextStep = $(this).data("next");
                showStep(nextStep);
                $("input[name='currentStep']").val(nextStep);
            });

            $("#continue-test").on("click", function () {
                $("#fulfill-overlay").hide();
                // Optionally, you could automatically move to the next step here
                // showStep(currentStep + 1);
            });

            $("#submit-test").on("click", function () {
                alert($.parseHTML('@Localizer.TextIgnoreCase("Test submitted successfully!")')[0].textContent);
                // Add form submission logic here
            });
            
            // Auto-save every 5 minutes
            setInterval(function () {
                saveTestProgress();
            }, 120000);

        });

        function saveTestProgress() {
            let data = $("#testForm").serialize();
            $.ajax({
                url: '?handler=SaveProgress',
                type: 'POST',
                data: data,
                success: function (data) {
                    console.log('Test progress saved successfully!');
                },
                error: function (error) {
                    console.error('Error saving test progress:', error);
                }
            });
        }
    </script>
}
